---
title: æ¨¡å—ä¸æ’ä»¶
date: 2023-07-31 01:56:35
permalink: /pages/c30e11/
---
[[toc]]
# æ¨¡å—ä¸æ’ä»¶ Module & Plugin
::: tip è¯´æ˜
ChopperBotæ˜¯**ç”±å¤šä¸ªæ¨¡å—ç»„æˆçš„ï¼Œæ¨¡å—ä¸­åˆåŒ…å«äº†å„ç§å„æ ·çš„æ’ä»¶**ã€‚æ¯ä¸€ä¸ªæ¨¡å—å’Œæ’ä»¶éƒ½æœ‰ç€è‡ªå·±çš„`å¯åŠ¨å™¨`ï¼Œæ’ä»¶ç”±`æ’ä»¶æ³¨å†Œè¡¨`è¿›è¡Œç®¡ç†ï¼ŒåŒæ—¶é…ç½®æ–‡ä»¶çš„pluginStartç®¡ç†ç€
æ’ä»¶çš„å¼€æœºå¯åŠ¨ï¼Œåœ¨é¡¹ç›®è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ’ä»¶å¯ä»¥éšæ—¶å¼€å¯éšæ—¶å¯åŠ¨ï¼ˆä¾èµ–æ’ä»¶å¯åŠ¨çš„å‰æä¸‹ï¼‰ã€‚æ¨¡å—å’Œæ’ä»¶æ—¶ChopperBotçš„çµé­‚ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†äº†è§£å¦‚ä½•ç¼–å†™åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„æ¨¡å—å’Œæ’ä»¶
:::

::: tip ä»€ä¹ˆæ˜¯ä¾èµ–?
åœ¨ChopperBotä¸­æœ‰è®¸å¤šçš„æ’ä»¶ï¼Œè€Œæœ‰äº›æ’ä»¶éœ€è¦ä¾èµ–å¦ä¸€ä¸ªæ’ä»¶çš„åŠŸèƒ½ï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ’ä»¶ä¾¿æ„æˆäº†`ä¾èµ–å…³ç³»`ã€‚
</br>åœ¨ChopperBotä¸­ä¾èµ–æ˜¯æ’ä»¶å¾ˆé‡è¦çš„å…³è”ï¼Œå®ƒå†³å®šäº†ä¸€ä¸ªæ’ä»¶çš„`å¼€å¯ï¼Œå…³é—­ä»¥åŠå¯åŠ¨é¡ºåº`ã€‚ä¸€æ—¦å‡ºç°ä¾èµ–æ’ä»¶ç¼ºå°‘æˆ–è€…å¾ªç¯ä¾èµ–éƒ½ä¼šå¯¼è‡´
ChopperBotåœæ­¢è¯¥æ’ä»¶çš„è¿è¡Œã€‚
:::

# å¯åŠ¨å™¨ InitMachine
æ¯ä¸ªæ’ä»¶å’Œæ¨¡å—éƒ½æ‹¥æœ‰ç€å±äºè‡ªå·±çš„å¯åŠ¨å™¨ï¼Œè€Œä½¿ç”¨å¯åŠ¨å™¨å¯åŠ¨çš„å¥½å¤„æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š
1. å¯¹æ’ä»¶è¿›è¡Œä¾èµ–æ£€æµ‹
2. æ’ä»¶å¯åŠ¨æ—¥å¿—å£°æ˜
3. ä¸ºæ’ä»¶æä¾›äº†å‡ºç”Ÿåˆ°æ­»äº¡çš„ä¸€æ¡é¾™æ–¹æ³•

- æ¨¡å—å¯åŠ¨å™¨éœ€è¦ç»§æ‰¿`ModuleInitMachine`
- æ’ä»¶å¯åŠ¨å™¨éœ€è¦ç»§æ‰¿`CommonInitMachine`

## InitMachineé€šç”¨æ–¹æ³•ä»‹ç»
| æ–¹æ³•å | æ–¹æ³•ä»‹ç» |
| :-: | :-: |
| init() boolean| åˆå§‹åŒ–æ“ä½œ |
| afterInit() void | åˆå§‹åŒ–ä¹‹åè¿›è¡Œçš„æ“ä½œ(åœ¨æ•´ä¸ªé¡¹ç›®å¯åŠ¨æ—¶ï¼Œæ˜¯åœ¨æ‰€æœ‰æ¨¡å—å¯åŠ¨å®Œåæ‰ä¼šæ‰§è¡Œ) |
| shutdown() void | å…³é—­æ“ä½œ |

## æ¨¡å—

### æ¨¡å—çš„åˆ›å»º
æ¨¡å—çš„åˆ›å»ºå¾ˆç®€å•ï¼Œåªéœ€ç®€å•çš„éµå¾ªä»¥ä¸‹ä¸¤æ­¥~
- åœ¨å½“å‰çš„é¡¹ç›®ä¸‹åˆ›å»º `init/module` æ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ¨¡å—å¯åŠ¨ç±»
```
+-- æ¨¡å—
|   +-- init
|   |  +-- module
|   |  |  +-- æ¨¡å—å¯åŠ¨ç±»
```
- ç»§æ‰¿ModuleInitMachine
```java
public class GeniusModuleInitMachine extends ModuleInitMachine {
    
    //è¿™é‡Œè¦æ˜¯æ— å‚æ„é€ å‡½æ•°
    public GeniusModuleInitMachine() {
        super(
                List.of(ConstPool.FILE),                        // ä¾èµ–çš„æ¨¡å—åç§°
                ChopperLogFactory.getLogger("Genius"),          // ä¾èµ–çš„æ¨¡å—æ—¥å¿—åç§°
                "Genius"                                        // æ¨¡å—åç§°
        );
    }
}
```
åªéœ€è¿™ä¸¤æ­¥ï¼Œåœ¨å¯åŠ¨é¡¹ç›®åä¼šè‡ªåŠ¨æ£€æµ‹åˆ°è¯¥æ¨¡å—ï¼Œå¹¶è¿›è¡Œæ¨¡å—çš„å¯åŠ¨é˜Ÿåˆ—ä¸­ï¼Œååˆ†æ–¹ä¾¿ğŸ‰~
## æ’ä»¶

### æ’ä»¶çš„ç§ç±»
ç›®å‰ChopperBotçš„æ’ä»¶ç±»å‹åˆ†ä¸ºä¸‰ç§:

| æ’ä»¶ç±»å‹ | æ’ä»¶ç±» | è¯´æ˜ |
| :-: | :-: | :-: |
| æ™®é€šæ’ä»¶ | `CommonPlugin` | ChopperBotæœ€ä¸ºå¸¸è§çš„æ’ä»¶ï¼Œå’ŒMCä¸­çš„æ³¥åœŸä¸€æ ·å¸¸è§ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚å°±ä½¿ç”¨å®ƒ |
| å®ˆå«æ’ä»¶ | `GuardPlugin` | å®ˆå«æ’ä»¶æŒ‡çš„æ˜¯ï¼Œå•çº¿ç¨‹ä¸”éœ€è¦ä¸åœè¿è¡Œçš„æ’ä»¶ï¼Œè¯¥æ’ä»¶å°†æ”¾å…¥ç³»ç»Ÿçš„å®ˆå«çº¿ç¨‹æ± `ChopperBotGuardPool`è¿è¡Œ |
| æ–‡ä»¶æ’ä»¶ | `ConfigFile`   | ChopperBotä¸­çš„æ–‡ä»¶ï¼Œç»§æ‰¿è¯¥ç±»åï¼Œè¿›è¡Œæ’ä»¶åˆå§‹åŒ–å°†è‡ªåŠ¨åˆ›å»ºå¹¶æ”¾å…¥`FileCacheManager`è¿›è¡Œç®¡ç† |

### æ’ä»¶çš„åˆ›å»º
æ’ä»¶çš„åˆ›å»ºåˆ†ä¸ºä¸¤ä¸ªå¤§æ­¥éª¤:1,æ’ä»¶çš„ç¼–å†™ 2,æ’ä»¶å¯åŠ¨å™¨çš„ç¼–å†™

#### 1,CommonPluginçš„åˆ›å»º
- æ„é€ æ–¹æ³•ç›®å‰å¿…é¡»é‡å†™ï¼Œè€Œä¸”å‚æ•°é¡ºåºä¸èƒ½å˜ï¼Œä¹Ÿä¸èƒ½å¢åŠ 
- é‡å†™åˆå§‹åŒ–æ“ä½œï¼ŒæŠŠæ’ä»¶å„ä¸ªå‚æ•°çš„åˆå§‹åŒ–æ”¾å…¥initæˆ–è€…æ”¾å…¥æ„é€ æ–¹æ³•éƒ½å¯
```java
public class GeniusPlugin extends CommonPlugin {
    //é‡å†™æ„é€ æ–¹æ³• ä¸”å‚æ•°é¡ºåºä¸èƒ½å˜
    public GeniusPlugin(String module, String pluginName, List<String> needPlugins, boolean isAutoStart) {
        super(module, pluginName, needPlugins, isAutoStart);
    }
    
    //åˆå§‹åŒ–æ“ä½œ
    @Override
    public boolean init() {
        
    }
    
    //å…³é—­æ“ä½œ
    @Override
    public void shutdown() {
    }
    
    //åˆå§‹åŒ–åçš„æ“ä½œ
    @Override
    public void afterInit() {
    }
}
```
#### 2,GuardPluginçš„åˆ›å»º
::: tip GuardPlugin
GuardPluginæ’ä»¶å¯åŠ¨åï¼Œä¼šè‡ªåŠ¨äº¤ç»™åˆ°ChopperBotGuardPoolè¿è¡Œï¼Œæ­£å› ä¸ºæ­¤æ—¶å®ƒçš„è¿è¡Œæ—¶æœºå’Œå…³é—­æœºåˆ¶éƒ½è¦ä¸å…¶ä»–çš„æ’ä»¶ä¸åŒï¼Œä¸»è¦ç”±ä»¥ä¸‹å‚æ•°æ§åˆ¶
| å‚æ•° | å‚æ•°è¯´æ˜ |
| :-: | :-: |
| isStop | è´Ÿè´£å…³é—­åœ¨çº¿ç¨‹æ± ä¸­è¿è¡Œçš„GuardPluginæ’ä»¶ | 
| afterDo | falseæ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±è¿è¡Œ,trueåœ¨åˆå§‹åŒ–ç»“æŸåæ‰è¿è¡Œ |


:::
- æ„é€ æ–¹æ³•ç›®å‰å¿…é¡»é‡å†™ï¼Œè€Œä¸”å‚æ•°é¡ºåºä¸èƒ½å˜ï¼Œä¹Ÿä¸èƒ½å¢åŠ 
- é‡å†™åˆå§‹åŒ–æ“ä½œï¼ŒæŠŠæ’ä»¶å„ä¸ªå‚æ•°çš„åˆå§‹åŒ–æ”¾å…¥initæˆ–è€…æ”¾å…¥æ„é€ æ–¹æ³•éƒ½å¯ï¼Œéœ€è¦ä½¿ç”¨çˆ¶ç±»çš„init()
- é‡å†™startæ–¹æ³•ï¼Œä¸éœ€è¦åœ¨æ–¹æ³•ä¸ŠåµŒå¥—whileå¾ªç¯ï¼ŒGuardPluginè‡ªå¸¦äº†
```
start(){
    print()
}
åŒç­‰äº
while{
    print() 
}
```
- å¦‚æœè¦é‡å†™shutdownæ–¹æ³•ï¼Œéœ€è¦è°ƒç”¨çˆ¶ç±»çš„shutdown()
```java
public class GeniusGuardPlugin extends GuardPlugin {
    public GeniusGuardPlugin(String module, String pluginName, List<String> needPlugins, boolean isAutoStart) {
        super(module, pluginName, needPlugins, isAutoStart);
        //afterDo = true; åˆå§‹åŒ–åè¿è¡Œ
    }

    //åˆå§‹åŒ–æ“ä½œã€‚é‡å†™æ—¶è¯·ä½¿ç”¨çˆ¶ç±»çš„init
    @Override
    public boolean init() {
        super.init();
        //ä»£ç 
    }
    
    //è¿è¡Œæ–¹æ³•ï¼ŒChopperBotGuardPoolå°†ä¼šä¸æ–­è¿è¡Œè¿™ä¸ªæ–¹æ³•
    @Override
    public void start(){
        
    }

    //å…³é—­æ“ä½œ,è¯·ä½¿ç”¨çˆ¶ç±»çš„shutdownï¼Œæˆ–è€…è‡ªè¡Œè¿›è¡ŒisStopçš„æ›´æ”¹
    @Override
    public void shutdown() {
        super.shutdown();
        //ä»£ç 
    }
    
    //åˆå§‹åŒ–åæ“ä½œï¼Œè¯·ä½¿ç”¨çˆ¶ç±»afterInit()
    @Override
    public void afterInit() {
        super.afterInit();
        //ä»£ç 
    }
}
```
#### 3,ConfigFileçš„åˆ›å»º
é…ç½®æ–‡ä»¶æ’ä»¶è¿ç”¨å¾ˆç®€å•ï¼Œå…³äºå…·ä½“é…ç½®æ–‡ä»¶è¯¥å¦‚ä½•å®šä¹‰è¯·è§[é…ç½®æ–‡ä»¶](/pages/1c428e/) ğŸ‘ˆ
```java
public class GeniusConfigFile extends ConfigFile<æ•°æ®ç±»å‹> {
    public GeniusConfigFile(String module, String pluginName, List<String> needPlugins, boolean isAutoStart) {
        super(module,pluginName,needPlugins,isAutoStart
                ,filePath, fileName,//æ–‡ä»¶è·¯å¾„ æ–‡ä»¶å
                Map.of("taskCenter",new TaskCenterConfig(10,50,1000)),  //æ–‡ä»¶å†…å®¹
                FileType.CREEPER);  //æ–‡ä»¶ç±»å‹
    }
}
```
### å¯åŠ¨å™¨åˆ›å»º

å¯åŠ¨å™¨çš„åˆ›å»ºåˆ†ä¸ºä¸¤æ­¥éª¤
- ç»§æ‰¿CommonInitMachine
- é‡å†™æ„é€ æ–¹æ³•
- è¡¨ä¸ŠPluginæ³¨è§£
```java
@Plugin(moduleName = æ‰€å±æ¨¡å—å,
        pluginName = æ’ä»¶åç§°,
        needPlugin = {æ‰€ä¾èµ–çš„æ’ä»¶},
        pluginClass= è¦åˆå§‹åŒ–çš„æ’ä»¶ç±» )
public class HotGuardInitMachine extends CommonInitMachine {


    public HotGuardInitMachine(List<String> needPlugins, boolean isAutoStart, String moduleName, String name, Class<? extends CommonPlugin> clazz) {
        super(needPlugins, isAutoStart, moduleName, name, clazz);
    }
}
```
- å¦‚æœéœ€è¦é‡å†™init(),afterInit(),shutdown()ã€‚è¯·åœ¨å…¶ä¸­ä½¿ç”¨superä¸­å¯¹åº”çš„æ–¹æ³•ã€‚

### æ’ä»¶æ³¨å†Œè¡¨
ChopperBotä¸­çš„æ‰€æœ‰æ’ä»¶ä¿¡æ¯ï¼Œéƒ½å­˜æ”¾åœ¨`InitPluginRegister`å…¨å±€ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æ–¹æ³•è·å–æ’ä»¶ä¿¡æ¯
```
//è·å¾—å…¨éƒ¨æ’ä»¶
InitPluginRegister.allPlugin;
//è·å–æŸæ¨¡å—ä¸‹æ‰€æœ‰æ’ä»¶
InitPluginRegister.modulePlugin.get(æ¨¡å—å);

//è·å–æŸæ’ä»¶çš„æ‰€æœ‰å­æ’ä»¶
InitPluginRegister.fatherAndSonPlugin.get(æ’ä»¶å);

//è·å¾—æŸæ’ä»¶è‡ªèº«æ¨¡å—ä¸‹çš„æ‰€æœ‰å­æ’ä»¶
InitPluginRegister.moduleFatherAndSonPlugin.get(æ’ä»¶å);

//åˆ¤æ–­æ’ä»¶æ˜¯å¦æ³¨å†Œ
InitPluginRegister.isRegister(æ’ä»¶å);

//è·å–æ­£åœ¨è¿è¡Œçš„æ’ä»¶
InitPluginRegister.getPluginæ’ä»¶å);

//æ³¨å†Œæ’ä»¶
InitPluginRegister.register(CommonInitMachine);
```
